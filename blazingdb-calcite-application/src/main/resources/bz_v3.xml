<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

	<changeSet id="1"
		author="Percy Camilo Triveño Aucahuasi - percy@blazingdb.com">
		<createTable tableName="blazing_catalog_column_datatypes">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="varchar(128)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createIndex tableName="blazing_catalog_column_datatypes"
			indexName="ix_blazing_catalog_column_datatypes_name">
			<column name="name"></column>
		</createIndex>

		<createTable tableName="blazing_catalog_columns">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="varchar(50)">
				<constraints nullable="false" />
			</column>
			<column name="data_type_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addForeignKeyConstraint
			constraintName="fk_blazing_catalog_columns_blazing_catalog_column_datatypes"
			baseTableName="blazing_catalog_columns" baseColumnNames="data_type_id"
			referencedTableName="blazing_catalog_column_datatypes"
			referencedColumnNames="id" />

		<createIndex tableName="blazing_catalog_columns"
			indexName="ix_blazing_catalog_columns_name">
			<column name="name" />
		</createIndex>

		<createTable tableName="blazing_catalog_tables">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="varchar(50)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<createIndex tableName="blazing_catalog_tables"
			indexName="ix_blazing_catalog_tables_name">
			<column name="name" />
		</createIndex>

		<createTable tableName="blazing_catalog_tables_columns">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="table_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="column_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addForeignKeyConstraint constraintName="fk_user_database_user"
			baseTableName="blazing_catalog_tables_columns" baseColumnNames="table_id"
			referencedTableName="blazing_catalog_tables" referencedColumnNames="id" />

		<addForeignKeyConstraint constraintName="fk_user_database_database"
			baseTableName="blazing_catalog_tables_columns" baseColumnNames="column_id"
			referencedTableName="blazing_catalog_columns" referencedColumnNames="id" />
	</changeSet>

	<changeSet id="3"
		author="Percy Camilo Triveño Aucahuasi - percy@blazingdb.com">
		<renameTable newTableName="blazing_database" oldTableName="database" />
	</changeSet>

	<changeSet id="4"
		author="Percy Camilo Triveño Aucahuasi - percy@blazingdb.com">
		<addUniqueConstraint tableName="users"
			columnNames="username" />
		<addUniqueConstraint tableName="blazing_database"
			columnNames="user_id,name" />
	</changeSet>

	<changeSet id="5"
		author="Percy Camilo Triveño Aucahuasi - percy@blazingdb.com">
		<dropNotNullConstraint tableName="users"
			columnName="password" columnDataType="varchar(45)" />
		<dropNotNullConstraint tableName="users"
			columnName="name" columnDataType="varchar(128)" />
	</changeSet>

	<changeSet id="6"
		author="Percy Camilo Triveño Aucahuasi - percy@blazingdb.com">
		<createTable tableName="invited_user">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="database_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="email" type="varchar(254)">
				<constraints nullable="false" />
			</column>
		</createTable>
		<modifyDataType tableName="users" columnName="username"
			newDataType="varchar(254)" />
	</changeSet>

	<changeSet id="7"
		author="Percy Camilo Triveño Aucahuasi - percy@blazingdb.com">
		<addColumn tableName="users">
			<column name="showTips" type="BOOLEAN" defaultValue="1">
				<constraints nullable="false" />
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="8"
		author="Percy Camilo Triveño Aucahuasi - percy@blazingdb.com">
		<dropDefaultValue columnDataType="BOOLEAN"
			columnName="showTips" tableName="users" />
		<addDefaultValue columnDataType="BOOLEAN" columnName="showTips"
			defaultValueBoolean="true" tableName="users" />
		<createTable tableName="iams">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="userId" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="username" type="varchar(64)">
				<constraints nullable="false" />
			</column>
			<column name="accessKeyId" type="BLOB">
				<constraints nullable="false" />
			</column>
			<column name="secretAccessKey" type="BLOB">
				<constraints nullable="false" />
			</column>
			<column name="accessKeyIdIv" type="BLOB">
				<constraints nullable="false" />
			</column>
			<column name="secretAccessKeyIv" type="BLOB">
				<constraints nullable="false" />
			</column>

		</createTable>
	</changeSet>

	<changeSet id="9"
		author="Percy Camilo Triveño Aucahuasi - percy@blazingdb.com">
		<createTable tableName="user_token">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="username" type="varchar(128)">
				<constraints nullable="false" />
			</column>
			<column name="token" type="varchar(64)">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="10"
		author="Percy Camilo Triveño Aucahuasi - percy@blazingdb.com">
		<createTable tableName="blazing_permission">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="username" type="varchar(256)"></column>
			<column name="role_name" type="varchar(256)"></column>
			<column name="schema" type="varchar(256)">
				<constraints nullable="false" />
			</column>
			<column name="database_name" type="varchar(256)">
				<constraints nullable="false" />
			</column>

			<column name="table_name" type="varchar(256)"></column>
			<column name="column_name" type="varchar(256)"></column>
			<column name="permission_type" type="varchar(32)">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="11"
		author="Percy Camilo Triveño Aucahuasi - percy@blazingdb.com">
		<dropColumn tableName="blazing_permission" columnName="schema" />
	</changeSet>

	<changeSet id="12"
		author="Percy Camilo Triveño Aucahuasi - percy@blazingdb.com">
		<addUniqueConstraint tableName="blazing_permission"
			columnNames="username, role_name, database_name, table_name, column_name, permission_type" />
	</changeSet>

</databaseChangeLog>
